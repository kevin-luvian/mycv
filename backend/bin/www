#!/usr/bin/env node

/**
 * Module dependencies.
 */

const app = require('./app');
const dotenv = require("dotenv");
const mongoose = require("mongoose");
const startup = require("./serverstartup");

/**
 * Setup config.
 */

dotenv.config();
// const port = process.env.PORT || '9000';
const port = normalizePort(process.env.PORT ? process.env.PORT : '9000');

function normalizePort(val) {
  var port = parseInt(val, 10);

  if (isNaN(port)) {
    // named pipe
    return val;
  }

  if (port >= 0) {
    // port number
    return port;
  }

  return false;
}

/**
 * Database setup
 */

mongoose.connect(process.env.MONGO_DB, {
  poolSize: 10,
  useNewUrlParser: true,
  useUnifiedTopology: true,
  useCreateIndex: true,
  useFindAndModify: false
});
const connection = mongoose.connection;
connection.on("error", console.error.bind(console, "[setup] MongoDB connection error:"));
connection.once("open", function () {
  console.log("[setup] MongoDB connection established");

  /**
   * Listen on provided port, on all network interfaces.
   */
  app.listen(port, function (err) {
    if (err) console.log("Error in server setup")
    console.log("[setup] Server listening on Port", port);

    startup();
  })
});
